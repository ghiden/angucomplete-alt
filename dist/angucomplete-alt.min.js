/*! Copyright (c) 2014 Hidenari Nozaki and contributors | Licensed under the MIT license */
"use strict";angular.module("angucomplete-alt",[]).directive("angucompleteAlt",["$q","$parse","$http","$sce","$timeout","$templateCache",function(a,b,c,d,e,f){var g=40,h=39,i=38,j=37,k=27,l=13,o=9,p=3,q=500,r=200,s="autocomplete-required",t="Searching...",u="No results found",v="/angucomplete-alt/index.html";return f.put(v,'<div class="angucomplete-holder" ng-class="{\'angucomplete-dropdown-visible\': showDropdown}">  <input id="{{id}}_value" ng-model="searchStr" ng-disabled="disableInput" type="text" placeholder="{{placeholder}}" ng-focus="onFocusHandler()" class="{{inputClass}}" ng-focus="resetHideResults()" ng-blur="hideResults($event)" autocapitalize="off" autocorrect="off" autocomplete="off" ng-change="inputChangeHandler(searchStr)"/>  <div id="{{id}}_dropdown" class="angucomplete-dropdown" ng-show="showDropdown">    <div class="angucomplete-searching" ng-show="searching" ng-bind="textSearching"></div>    <div class="angucomplete-searching" ng-show="!searching && (!results || results.length == 0)" ng-bind="textNoResults"></div>    <div class="angucomplete-row" ng-repeat="result in results" ng-click="selectResult(result)" ng-mouseenter="hoverRow($index)" ng-class="{\'angucomplete-selected-row\': $index == currentIndex}">      <div ng-if="imageField" class="angucomplete-image-holder">        <img ng-if="result.image && result.image != \'\'" ng-src="{{result.image}}" class="angucomplete-image"/>        <div ng-if="!result.image && result.image != \'\'" class="angucomplete-image-default"></div>      </div>      <div class="angucomplete-title" ng-if="matchClass" ng-bind-html="result.title"></div>      <div class="angucomplete-title" ng-if="!matchClass">{{ result.title }}</div>      <div ng-if="matchClass && result.description && result.description != \'\'" class="angucomplete-description" ng-bind-html="result.description"></div>      <div ng-if="!matchClass && result.description && result.description != \'\'" class="angucomplete-description">{{result.description}}</div>    </div>  </div></div>'),{restrict:"EA",require:"^?form",scope:{selectedObject:"=",disableInput:"=",initialValue:"@",localData:"=",remoteUrlRequestFormatter:"=",remoteUrlResponseFormatter:"=",remoteUrlErrorCallback:"=",id:"@",placeholder:"@",remoteUrl:"@",remoteUrlDataField:"@",titleField:"@",descriptionField:"@",imageField:"@",inputClass:"@",pause:"@",searchFields:"@",minlength:"@",matchClass:"@",clearSelected:"@",overrideSuggestions:"@",fieldRequired:"@",fieldRequiredClass:"@",inputChanged:"=",autoMatch:"@",focusOut:"&",focusIn:"&"},templateUrl:function(a,b){return b.templateUrl||v},link:function(b,f,m,n){function H(a){return a.which?a.which:a.keyCode}function I(a){"function"==typeof b.selectedObject?b.selectedObject(a):b.selectedObject=a,a?O(!0):O(!1)}function J(a){return function(c){return b[a]?b[a](c):c}}function K(a){I({originalObject:a}),b.clearSelected&&(b.searchStr=null),ab()}function L(a){return b.titleField.split(",").map(function(b){return M(a,b)}).join(" ")}function M(a,b){var c,d;return b?(c=b.split("."),d=a,c.forEach(function(a){d=d[a]})):d=a,d}function N(a,c){var e,f,g=new RegExp(c,"i");if(a)return f=a.match(g),e=f?a.replace(g,'<span class="'+b.matchClass+'">'+f[0]+"</span>"):a,d.trustAsHtml(e)}function O(a){B=b.searchStr,b.fieldRequired&&n&&n.$setValidity(z,a)}function P(a){var c=H(a);c!==j&&c!==h&&(c===i||c===l?a.preventDefault():c===g?(a.preventDefault(),!b.showDropdown&&b.searchStr&&b.searchStr.length>=w&&(bb(),b.searching=!0,eb(b.searchStr))):c===k?(ab(),b.$apply(function(){v.val(b.searchStr)})):(b.searchStr&&""!==b.searchStr?b.searchStr.length>=w&&(bb(),x&&e.cancel(x),b.searching=!0,x=e(function(){eb(b.searchStr)},b.pause)):b.showDropdown=!1,B&&B!==b.searchStr&&!b.clearSelected&&I(void 0)))}function Q(a){!b.overrideSuggestions||b.selectedObject&&b.selectedObject.originalObject===b.searchStr||(a&&a.preventDefault(),K(b.searchStr))}function R(a){var b=getComputedStyle(a);return a.offsetHeight+parseInt(b.marginTop,10)+parseInt(b.marginBottom,10)}function S(){return D.getBoundingClientRect().top+parseInt(getComputedStyle(D).maxHeight,10)}function T(){return f[0].querySelectorAll(".angucomplete-row")[b.currentIndex]}function U(){return T().getBoundingClientRect().top-(D.getBoundingClientRect().top+parseInt(getComputedStyle(D).paddingTop,10))}function V(a){D.scrollTop=D.scrollTop+a}function W(){var a=b.results[b.currentIndex];b.matchClass?v.val(L(a.originalObject)):v.val(a.title)}function X(a){var c=H(a),d=null,e=null;c===l&&b.results?(b.currentIndex>=0&&b.currentIndex<b.results.length?(a.preventDefault(),b.selectResult(b.results[b.currentIndex])):(Q(a),ab()),b.$apply()):c===g&&b.results?(a.preventDefault(),b.currentIndex+1<b.results.length&&b.showDropdown&&(b.$apply(function(){b.currentIndex++,W()}),E&&(d=T(),S()<d.getBoundingClientRect().bottom&&V(R(d))))):c===i&&b.results?(a.preventDefault(),b.currentIndex>=1?(b.$apply(function(){b.currentIndex--,W()}),E&&(e=U(),0>e&&V(e-1))):0===b.currentIndex&&b.$apply(function(){b.currentIndex=-1,v.val(b.searchStr)})):c===o&&(b.results&&b.results.length>0&&b.showDropdown?-1===b.currentIndex&&b.overrideSuggestions?Q():(-1===b.currentIndex&&(b.currentIndex=0),b.selectResult(b.results[b.currentIndex]),b.$digest()):b.searchStr&&b.searchStr.length>0&&Q())}function Y(a){return function(c){b.searching=!1,fb(M(A(c),b.remoteUrlDataField),a)}}function Z(a,c,d,e){0!==c&&(b.remoteUrlErrorCallback?b.remoteUrlErrorCallback(a,c,d,e):console&&console.error&&console.error("http error"))}function $(){C&&C.resolve()}function _(d){var e={},f=b.remoteUrl+d;b.remoteUrlRequestFormatter&&(e={params:b.remoteUrlRequestFormatter(d)},f=b.remoteUrl),$(),C=a.defer(),e.timeout=C.promise,c.get(f,e).success(Y(d)).error(Z)}function ab(){b.showDropdown=!1,b.results=[],D&&(D.scrollTop=0)}function bb(){b.showDropdown=!0,b.currentIndex=-1,b.results=[]}function cb(a){var c,d,e,f,g=b.searchFields.split(","),h=[];for(c=0;c<b.localData.length;c++){for(d=!1,e=0;e<g.length;e++)f=M(b.localData[c],g[e])||"",d=d||f.toLowerCase().indexOf(a.toLowerCase())>=0;d&&(h[h.length]=b.localData[c])}b.searching=!1,fb(h,a)}function db(a,c,d){for(var e in c)if(c[e].toLowerCase()===d.toLowerCase())return b.selectResult(a),void 0}function eb(a){a.length<w||(b.localData?b.$apply(function(){cb(a)}):_(a))}function fb(a,c){var d,e,f,g,h,i;if(a&&a.length>0)for(b.results=[],d=0;d<a.length;d++)b.titleField&&""!==b.titleField&&(g=h=L(a[d])),e="",b.descriptionField&&(e=i=M(a[d],b.descriptionField)),f="",b.imageField&&(f=M(a[d],b.imageField)),b.matchClass&&(h=N(g,c),i=N(e,c)),b.results[b.results.length]={title:h,description:i,image:f,originalObject:a[d]},b.autoMatch&&db(b.results[b.results.length-1],{title:g,desc:e||""},b.searchStr);else b.results=[]}var y,A,G,v=f.find("input"),w=p,x=null,z=s,B=null,C=null,D=f[0].querySelector(".angucomplete-dropdown"),E=!1,F=null;f.on("mousedown",function(a){F=a.target.id}),b.currentIndex=null,b.searching=!1,b.searchStr=b.initialValue,G=b.$watch("initialValue",function(a){a&&a.length>0&&(b.searchStr=b.initialValue,O(!0),G())}),b.$on("angucomplete-alt:clearInput",function(a,c){c?b.id===c&&(b.searchStr=null,ab()):(b.searchStr=null,ab())}),b.onFocusHandler=function(){b.focusIn&&b.focusIn()},b.hideResults=function(){F===b.id+"_dropdown"?F=null:(y=e(function(){ab(),b.$apply(function(){b.searchStr&&b.searchStr.length>0&&v.val(b.searchStr)})},r),$(),b.focusOut&&b.focusOut())},b.resetHideResults=function(){y&&e.cancel(y)},b.hoverRow=function(a){b.currentIndex=a},b.selectResult=function(a){b.matchClass&&(a.title=L(a.originalObject),a.description=M(a.originalObject,b.descriptionField)),b.searchStr=b.clearSelected?null:a.title,I(a),ab()},b.inputChangeHandler=function(a){return a.length<w&&ab(),b.inputChanged&&(a=b.inputChanged(a)),a},b.fieldRequiredClass&&""!==b.fieldRequiredClass&&(z=b.fieldRequiredClass),b.minlength&&""!==b.minlength&&(w=b.minlength),b.pause||(b.pause=q),b.clearSelected||(b.clearSelected=!1),b.overrideSuggestions||(b.overrideSuggestions=!1),b.fieldRequired&&n&&(b.initialValue?O(!0):O(!1)),b.textSearching=m.textSearching||t,b.textNoResults=m.textNoResults||u,b.$watch(function(){return m.textSearching},function(a){b.textSearching=a||t}),b.$watch(function(){return m.textNoResults},function(a){b.textNoResults=a||u}),v.on("keydown",X),v.on("keyup",P),A=J("remoteUrlResponseFormatter"),b.$on("$destroy",function(){O(!0)}),e(function(){var a=getComputedStyle(D);E=a.maxHeight&&"auto"===a.overflowY})}}}]);
