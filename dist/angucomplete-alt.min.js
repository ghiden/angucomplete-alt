/*! Copyright (c) 2014 Hidenari Nozaki and contributors | Licensed under the MIT license */
"use strict";angular.module("angucomplete-alt",[]).directive("angucompleteAlt",["$parse","$http","$sce","$timeout",function($parse,$http,$sce,$timeout){var KEY_DW=40,KEY_UP=38,KEY_ES=27,KEY_EN=13,KEY_BS=8,KEY_DEL=46,MIN_LENGTH=3,PAUSE=500,BLUR_TIMEOUT=200;return{restrict:"EA",require:"^?form",scope:{selectedObject:"=",localData:"=",remoteUrlRequestFormatter:"=",remoteUrlResponseFormatter:"=",id:"@",placeholder:"@",remoteUrl:"@",remoteUrlDataField:"@",titleField:"@",descriptionField:"@",imageField:"@",inputClass:"@",pause:"@",searchFields:"@",minlength:"@",matchClass:"@",clearSelected:"@",overrideSuggestions:"@",fieldRequired:"=?",validityLabel:"@"},template:'<div class="angucomplete-holder">  <input id="{{id}}_value" ng-model="searchStr" type="text" placeholder="{{placeholder}}" class="{{inputClass}}" ng-required="{{fieldRequired}}" ng-focus="resetHideResults()" ng-blur="hideResults()" autocapitalize="off" autocorrect="off" autocomplete="off"/>  <div id="{{id}}_dropdown" class="angucomplete-dropdown" ng-if="showDropdown">    <div class="angucomplete-searching" ng-show="searching">Searching...</div>    <div class="angucomplete-searching" ng-show="!searching && (!results || results.length == 0)">No results found</div>    <div class="angucomplete-row" ng-repeat="result in results" ng-click="selectResult(result)" ng-mouseover="hoverRow($index)" ng-class="{\'angucomplete-selected-row\': $index == currentIndex}">      <div ng-if="imageField" class="angucomplete-image-holder">        <img ng-if="result.image && result.image != \'\'" ng-src="{{result.image}}" class="angucomplete-image"/>        <div ng-if="!result.image && result.image != \'\'" class="angucomplete-image-default"></div>      </div>      <div class="angucomplete-title" ng-if="matchClass" ng-bind-html="result.title"></div>      <div class="angucomplete-title" ng-if="!matchClass">{{ result.title }}</div>      <div ng-if="matchClass && result.description && result.description != \'\'" class="angucomplete-description" ng-bind-html="result.description"></div>      <div ng-if="!matchClass && result.description && result.description != \'\'" class="angucomplete-description">{{result.description}}</div>    </div>  </div></div>',link:function(scope,elem,attrs,ctrl){function validate(){ctrl&&(scope.results&&scope.searchStr&&1===scope.results.length?scope.matchClass&&scope.results[0].title.$$unwrapTrustedValue&&scope.results[0].title.$$unwrapTrustedValue().toLowerCase()===scope.searchStr.toLowerCase()?(scope.selectResult(scope.results[0]),ctrl.$setValidity(validityLabel,!0)):scope.matchClass||scope.results[0].title.toLowerCase()!==scope.searchStr.toLowerCase()?ctrl.$setValidity(validityLabel,!1):(scope.selectResult(scope.results[0]),ctrl.$setValidity(validityLabel,!0)):ctrl.$setValidity(validityLabel,!1))}var inputField,hideTimer,validityLabel,minlength=MIN_LENGTH,searchTimer=null,lastSearchTerm=null;scope.currentIndex=null,scope.searching=!1,scope.searchStr=null,validityLabel=scope.validityLabel?scope.validityLabel:"match";var callOrAssign=function(value){"function"==typeof scope.selectedObject?scope.selectedObject(value):scope.selectedObject=value},returnFunctionOrIdentity=function(fn){return fn&&"function"==typeof fn?fn:function(data){return data}},responseFormatter=returnFunctionOrIdentity(scope.remoteUrlResponseFormatter),setInputString=function(str){callOrAssign({originalObject:str}),scope.clearSelected&&(scope.searchStr=null),scope.showDropdown=!1,scope.results=[]},isNewSearchNeeded=function(newTerm,oldTerm){return newTerm.length>=minlength&&newTerm!==oldTerm},extractTitle=function(data){return scope.titleField.split(",").map(function(field){return extractValue(data,field)}).join(" ")};validate();var extractValue=function(obj,key){var keys,result;return key?(keys=key.split("."),result=obj,keys.forEach(function(k){result=result[k]})):result=obj,result},findMatchString=function(target,str){var result,matches,re=new RegExp(str,"i");if(target)return matches=target.match(re),result=matches?target.replace(re,'<span class="'+scope.matchClass+'">'+matches[0]+"</span>"):target,$sce.trustAsHtml(result)};scope.minlength&&""!==scope.minlength&&(minlength=scope.minlength),scope.pause||(scope.pause=PAUSE),scope.clearSelected||(scope.clearSelected=!1),scope.overrideSuggestions||(scope.overrideSuggestions=!1),scope.hideResults=function(){hideTimer=$timeout(function(){scope.showDropdown=!1},BLUR_TIMEOUT)},scope.resetHideResults=function(){hideTimer&&$timeout.cancel(hideTimer)},scope.processResults=function(responseData,str){var i,description,image,text;if(responseData&&responseData.length>0)for(scope.results=[],i=0;i<responseData.length;i++)scope.titleField&&""!==scope.titleField&&(text=extractTitle(responseData[i])),description="",scope.descriptionField&&(description=extractValue(responseData[i],scope.descriptionField)),image="",scope.imageField&&(image=extractValue(responseData[i],scope.imageField)),scope.matchClass&&(text=findMatchString(text,str),description=findMatchString(description,str)),scope.results[scope.results.length]={title:text,description:description,image:image,originalObject:responseData[i]};else scope.results=[];validate()},scope.searchTimerComplete=function(str){var searchFields,matches,i,match,s,params;if(str.length>=minlength)if(scope.localData){for(searchFields=scope.searchFields.split(","),matches=[],i=0;i<scope.localData.length;i++){for(match=!1,s=0;s<searchFields.length;s++)match=match||scope.localData[i][searchFields[s]].toLowerCase().indexOf(str.toLowerCase())>=0;match&&(matches[matches.length]=scope.localData[i])}scope.searching=!1,scope.processResults(matches,str)}else scope.remoteUrlRequestFormatter?(params=scope.remoteUrlRequestFormatter(str),$http.get(scope.remoteUrl,{params:params}).success(function(responseData){scope.searching=!1,scope.processResults(extractValue(responseFormatter(responseData),scope.remoteUrlDataField),str)}).error(function(){console.log("error")})):$http.get(scope.remoteUrl+str,{}).success(function(responseData){scope.searching=!1,scope.processResults(extractValue(responseFormatter(responseData),scope.remoteUrlDataField),str)}).error(function(){console.log("error")})},scope.hoverRow=function(index){scope.currentIndex=index},scope.selectResult=function(result){scope.matchClass&&(result.title=extractTitle(result.originalObject),result.description=extractValue(result.originalObject,scope.descriptionField)),scope.searchStr=scope.clearSelected?null:lastSearchTerm=result.title,callOrAssign(result),scope.showDropdown=!1,ctrl&&ctrl.$setValidity(validityLabel,!0),scope.results=[]},inputField=elem.find("input"),scope.keyPressed=function(event){event.which!==KEY_UP&&event.which!==KEY_DW&&event.which!==KEY_EN?scope.searchStr&&""!==scope.searchStr?isNewSearchNeeded(scope.searchStr,lastSearchTerm)&&(lastSearchTerm=scope.searchStr,scope.showDropdown=!0,scope.currentIndex=-1,scope.results=[],searchTimer&&$timeout.cancel(searchTimer),scope.searching=!0,searchTimer=$timeout(function(){scope.searchTimerComplete(scope.searchStr)},scope.pause)):(scope.showDropdown=!1,lastSearchTerm=null):event.preventDefault()},inputField.on("keyup",scope.keyPressed),elem.on("keydown",function(event){event.which===KEY_EN&&scope.results?(event.preventDefault(),scope.currentIndex>=0&&scope.currentIndex<scope.results.length?(scope.selectResult(scope.results[scope.currentIndex]),scope.$apply()):scope.overrideSuggestions?(setInputString(scope.searchStr),scope.$apply()):(scope.results=[],scope.$apply())):event.which===KEY_DW&&scope.results?scope.currentIndex+1<scope.results.length&&scope.$apply(function(){scope.currentIndex++}):event.which===KEY_UP&&scope.results&&scope.currentIndex>=1&&scope.$apply(function(){scope.currentIndex--})}),elem.on("keyup",function(event){event.which===KEY_ES?(scope.results=[],scope.showDropdown=!1,scope.$apply()):(event.which===KEY_BS||event.which===KEY_DEL)&&scope.$apply()})}}}]);