/*! Copyright (c) 2014 Hidenari Nozaki and contributors | Licensed under the MIT license */
"use strict";angular.module("angucomplete-alt",[]).directive("angucompleteAlt",["$q","$parse","$http","$sce","$timeout",function(a,b,c,d,e){var f=40,g=39,h=38,i=37,j=27,k=13,l=9,m=3,n=500,o=200,p="autocomplete-required",q="Searching...",r="No results found";return{restrict:"EA",require:"^?form",scope:{selectedObject:"=",disableInput:"=",initialValue:"@",localData:"=",remoteUrlRequestFormatter:"=",remoteUrlResponseFormatter:"=",remoteUrlErrorCallback:"=",id:"@",placeholder:"@",remoteUrl:"@",remoteUrlDataField:"@",titleField:"@",descriptionField:"@",imageField:"@",inputClass:"@",pause:"@",searchFields:"@",minlength:"@",matchClass:"@",clearSelected:"@",overrideSuggestions:"@",fieldRequired:"@",fieldRequiredClass:"@",inputChanged:"=",autoMatch:"@",focusOut:"&",focusIn:"&"},template:'<div class="angucomplete-holder">  <input id="{{id}}_value" ng-model="searchStr" ng-disabled="disableInput" type="text" placeholder="{{placeholder}}" ng-focus="onFocusHandler()" class="{{inputClass}}" ng-focus="resetHideResults()" ng-blur="hideResults()" autocapitalize="off" autocorrect="off" autocomplete="off" ng-change="inputChangeHandler(searchStr)"/>  <div id="{{id}}_dropdown" class="angucomplete-dropdown" ng-if="showDropdown">    <div class="angucomplete-searching" ng-show="searching" ng-bind="textSearching"></div>    <div class="angucomplete-searching" ng-show="!searching && (!results || results.length == 0)" ng-bind="textNoResults"></div>    <div class="angucomplete-row" ng-repeat="result in results" ng-click="selectResult(result)" ng-mouseover="hoverRow($index)" ng-class="{\'angucomplete-selected-row\': $index == currentIndex}">      <div ng-if="imageField" class="angucomplete-image-holder">        <img ng-if="result.image && result.image != \'\'" ng-src="{{result.image}}" class="angucomplete-image"/>        <div ng-if="!result.image && result.image != \'\'" class="angucomplete-image-default"></div>      </div>      <div class="angucomplete-title" ng-if="matchClass" ng-bind-html="result.title"></div>      <div class="angucomplete-title" ng-if="!matchClass">{{ result.title }}</div>      <div ng-if="matchClass && result.description && result.description != \'\'" class="angucomplete-description" ng-bind-html="result.description"></div>      <div ng-if="!matchClass && result.description && result.description != \'\'" class="angucomplete-description">{{result.description}}</div>    </div>  </div></div>',link:function(b,s,t,u){function v(a){return a.which?a.which:a.keyCode}function w(a){"function"==typeof b.selectedObject?b.selectedObject(a):b.selectedObject=a,C(!0)}function x(a){return function(c){return b[a]?b[a](c):c}}function y(a){w({originalObject:a}),b.clearSelected&&(b.searchStr=null),K()}function z(a){return b.titleField.split(",").map(function(b){return A(a,b)}).join(" ")}function A(a,b){var c,d;return b?(c=b.split("."),d=a,c.forEach(function(a){d=d[a]})):d=a,d}function B(a,c){var e,f,g=new RegExp(c,"i");if(a)return f=a.match(g),e=f?a.replace(g,'<span class="'+b.matchClass+'">'+f[0]+"</span>"):a,d.trustAsHtml(e)}function C(a){U=b.searchStr,b.fieldRequired&&u&&u.$setValidity(T,a)}function D(a){var c=v(a);c!==i&&c!==g&&(c===h||c===k?a.preventDefault():c===f?(a.preventDefault(),!b.showDropdown&&b.searchStr.length>=R&&(L(),b.searching=!0,b.searchTimerComplete(b.searchStr))):c===j?(K(),b.$apply()):(b.searchStr&&""!==b.searchStr?b.searchStr.length>=R&&(L(),S&&e.cancel(S),b.searching=!0,S=e(function(){b.searchTimerComplete(b.searchStr)},b.pause)):b.showDropdown=!1,U&&U!==b.searchStr&&(w(void 0),C(!1))))}function E(a){b.overrideSuggestions&&(b.selectedObject&&b.selectedObject.originalObject===b.searchStr||(a.preventDefault(),y(b.searchStr)))}function F(a){var c=v(a);c===k&&b.results?(b.currentIndex>=0&&b.currentIndex<b.results.length?(a.preventDefault(),b.selectResult(b.results[b.currentIndex])):(E(a),K()),b.$apply()):c===f&&b.results?(a.preventDefault(),b.currentIndex+1<b.results.length&&b.$apply(function(){b.currentIndex++})):c===h&&b.results?(a.preventDefault(),b.currentIndex>=1&&b.$apply(function(){b.currentIndex--})):c===l&&b.results&&b.results.length>0&&-1===b.currentIndex&&b.showDropdown&&(b.selectResult(b.results[0]),b.$apply())}function G(a){return function(c){b.searching=!1,b.processResults(A(P(c),b.remoteUrlDataField),a)}}function H(a,c,d,e){0!==c&&(b.remoteUrlErrorCallback?b.remoteUrlErrorCallback(a,c,d,e):console&&console.error&&console.error("http error"))}function I(){V&&V.resolve()}function J(d){var e={},f=b.remoteUrl+d;b.remoteUrlRequestFormatter&&(e={params:b.remoteUrlRequestFormatter(d)},f=b.remoteUrl),I(),V=a.defer(),e.timeout=V.promise,c.get(f,e).success(G(d)).error(H)}function K(){b.showDropdown=!1,b.results=[]}function L(){b.showDropdown=!0,b.currentIndex=-1,b.results=[]}function M(a){var c,d,e,f=b.searchFields.split(","),g=[];for(c=0;c<b.localData.length;c++){for(d=!1,e=0;e<f.length;e++)d=d||b.localData[c][f[e]].toLowerCase().indexOf(a.toLowerCase())>=0;d&&(g[g.length]=b.localData[c])}b.searching=!1,b.processResults(g,a)}function N(a,c,d){for(var e in c)if(c[e].toLowerCase()===d.toLowerCase())return void b.selectResult(a)}var O,P,Q=s.find("input"),R=m,S=null,T=p,U=null,V=null;b.currentIndex=null,b.searching=!1,b.searchStr=b.initialValue,b.$watch("initialValue",function(){b.searchStr=b.initialValue}),b.onFocusHandler=function(){b.focusIn&&b.focusIn()},b.hideResults=function(){O=e(function(){b.showDropdown=!1},o),I(),b.focusOut&&b.focusOut()},b.resetHideResults=function(){O&&e.cancel(O)},b.processResults=function(a,c){var d,e,f,g,h,i;if(a&&a.length>0)for(b.results=[],d=0;d<a.length;d++)b.titleField&&""!==b.titleField&&(g=h=z(a[d])),e="",b.descriptionField&&(e=i=A(a[d],b.descriptionField)),f="",b.imageField&&(f=A(a[d],b.imageField)),b.matchClass&&(h=B(g,c),i=B(e,c)),b.results[b.results.length]={title:h,description:i,image:f,originalObject:a[d]},b.autoMatch&&N(b.results[b.results.length-1],{title:g,desc:e},b.searchStr);else b.results=[]},b.searchTimerComplete=function(a){a.length<R||(b.localData?b.$apply(function(){M(a)}):J(a))},b.hoverRow=function(a){b.currentIndex=a},b.selectResult=function(a){b.matchClass&&(a.title=z(a.originalObject),a.description=A(a.originalObject,b.descriptionField)),b.searchStr=b.clearSelected?null:a.title,w(a),K()},b.inputChangeHandler=function(a){return a.length<R&&K(),b.inputChanged&&(a=b.inputChanged(a)),a},b.fieldRequiredClass&&""!==b.fieldRequiredClass&&(T=b.fieldRequiredClass),b.minlength&&""!==b.minlength&&(R=b.minlength),b.pause||(b.pause=n),b.clearSelected||(b.clearSelected=!1),b.overrideSuggestions||(b.overrideSuggestions=!1),b.fieldRequired&&u&&C(b.initialValue?!0:!1),b.textSearching=t.textSearching?t.textSearching:q,b.textNoResults=t.textNoResults?t.textNoResults:r,Q.on("keydown",F),Q.on("keyup",D),P=x("remoteUrlResponseFormatter")}}}]);